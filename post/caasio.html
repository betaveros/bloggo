<!DOCTYPE html>
<html lang="en-us">
<head>
<meta charset="utf-8" />
<title>CaaSio PSE</title>

<meta name="author" content="betaveros" />
<meta name="description" content=" It’s clam’s newest javascript Calculator-as-a-Service: the CaaSio Please Stop Edition! no but actually please stop I hate jsjails js isn’t a good language stop putting one in every ctf I don’t want to look at another jsjail because if I do I might vomit from how much I hate js and js quirks aren’t even cool or funny or quirky they’re just painful because why would you design a language like this ahhhhhhhhhhhhhhhhhhhhh
It’s just a JavaScript eval jail.
#!/usr/local/bin/node // flag in ./flag.txt const vm = require(&amp;quot;vm&amp;quot;); const readline = require(&amp;quot;readline&amp;quot;); const interface = readline.createInterface({ input: process.stdin, output: process.stdout, }); interface.question( &amp;quot;Welcome to CaaSio: Please Stop Edition! Enter your calculation:\n&amp;quot;, function (input) { interface.close(); if ( input.length &amp;lt; 215 &amp;amp;&amp;amp; /^[\x20-\x7e]&#43;$/.test(input) &amp;amp;&amp;amp; !/[.\[\]{}\s;`&amp;#39;&amp;quot;\\_&amp;lt;&amp;gt;?:]/.test(input) &amp;amp;&amp;amp; !input.toLowerCase().includes(&amp;quot;import&amp;quot;) ) { try { const val = vm.runInNewContext(input, {}); console.log(&amp;quot;Result:&amp;quot;); console.log(val); console.log( &amp;quot;See, isn&amp;#39;t the calculator so much nicer when you&amp;#39;re not trying to hack it?&amp;quot; ); } catch (e) { console.log(&amp;quot;your tried&amp;quot;); } } else { console.log( &amp;quot;Third time really is the charm! I&amp;#39;ve finally created an unhackable system!&amp;quot; ); } } );" /><meta name="generator" content="Hugo 0.102.0-DEV" />

<link rel="canonical" href="//blog.vero.site/post/caasio" />
<link rel="alternative" href="/index.xml" title="Bounded-Error Log" type="application/atom+xml" />

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="format-detection" content="telephone=no,email=no,adress=no" />
<meta http-equiv="Cache-Control" content="no-transform" />

<meta name="robots" content="index,follow" />
<meta name="referrer" content="origin-when-cross-origin" />
<meta name="theme-color" content="#330000" />
<meta name="twitter:creator" content="@betaveros">

<link rel="icon" href="/favicon.ico" />

<link rel="stylesheet" href="/css/bundle.css" />
<link rel="stylesheet" href="/katex/katex.min.css" />

<!--[if lte IE 11]>
    <script src="//cdn.bootcss.com/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

</head>
<body>
<div id="wrapper">
<header class="site-header"><h2 class="title"><a href="/">Bounded-Error Log</a></h2><p class="subtitle">theoretical and applied randomness by <a href="https://beta.vero.site/">betaveros</a></p>
<button class="menu-toggle" type="button" aria-label="Toggle Menu">
	<span class="icon icon-menu" aria-hidden="true"></span>
</button>
<nav class="site-menu collapsed">
	<h2 class="offscreen">Main Menu</h2>
	<ul class="menu-list"><li class="menu-item "><a href="/about">About</a></li><li class="menu-item "><a href="/category/life">Life</a></li><li class="menu-item "><a href="/category/thoughts">Thoughts</a></li><li class="menu-item "><a href="/category/self-analysis">Self-Analysis</a></li><li class="menu-item "><a href="/category/math">Math</a></li><li class="menu-item "><a href="/category/cs">CS</a></li><li class="menu-item "><a href="/category/puzzles">Puzzles</a></li><li class="menu-item "><a href="/category/meta">Meta</a></li><li class="menu-item "><a href="/ref">References</a></li><li class="menu-item "><a href="/util">Utilities</a></li><li class="menu-item "><a href="/all">All Posts</a></li></ul>
</nav>
<nav class="social-menu collapsed">
	<h2 class="offscreen">Social Networks</h2>
	<ul class="social-list"><li class="social-item">
			<a href="//github.com/betaveros" title="GitHub" aria-label="GitHub"><span class="icon icon-github" aria-hidden="true"></span></a>

		</li><li class="social-item">
			<a href="/index.xml" title="RSS" aria-label="RSS"><span class="icon icon-rss" aria-hidden="true"></span></a>
		</li>
	</ul>
</nav>
</header>

<section class="main post-detail">
	<header>
		<h1 class="post-title">CaaSio PSE</h1>
		
		<h2 class="post-subtitle">ångstromCTF 2022 (250 points)</h2>
		
		<p class="post-meta">
		
		2022-07-04
		(773 words)
		
		<span class="post-categories">
			filed under
			<a href="/category/cs">CS</a>
		</span>
		
		</p>
	</header>
	<article><blockquote>
<p>It’s clam’s newest javascript Calculator-as-a-Service: the CaaSio Please Stop Edition! no but actually please stop I hate jsjails js isn’t a good language stop putting one in every ctf I don’t want to look at another jsjail because if I do I might vomit from how much I hate js and js quirks aren’t even cool or funny or quirky they’re just painful because why would you design a language like this ahhhhhhhhhhhhhhhhhhhhh</p>
</blockquote>
<p>It’s just a JavaScript eval jail.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" title="1"><span class="co">#!/usr/local/bin/node</span></a>
<a class="sourceLine" id="cb1-2" title="2"></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="co">// flag in ./flag.txt</span></a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="kw">const</span> vm <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;vm&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="kw">const</span> readline <span class="op">=</span> <span class="at">require</span>(<span class="st">&quot;readline&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-7" title="7"></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="kw">const</span> <span class="kw">interface</span> <span class="op">=</span> <span class="va">readline</span>.<span class="at">createInterface</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb1-9" title="9">    <span class="dt">input</span><span class="op">:</span> <span class="va">process</span>.<span class="at">stdin</span><span class="op">,</span></a>
<a class="sourceLine" id="cb1-10" title="10">    <span class="dt">output</span><span class="op">:</span> <span class="va">process</span>.<span class="at">stdout</span><span class="op">,</span></a>
<a class="sourceLine" id="cb1-11" title="11"><span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-12" title="12"></a>
<a class="sourceLine" id="cb1-13" title="13"><span class="kw">interface</span>.<span class="at">question</span>(</a>
<a class="sourceLine" id="cb1-14" title="14">    <span class="st">&quot;Welcome to CaaSio: Please Stop Edition! Enter your calculation:</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb1-15" title="15">    <span class="kw">function</span> (input) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-16" title="16">        <span class="kw">interface</span>.<span class="at">close</span>()<span class="op">;</span></a>
<a class="sourceLine" id="cb1-17" title="17">        <span class="cf">if</span> (</a>
<a class="sourceLine" id="cb1-18" title="18">            <span class="va">input</span>.<span class="at">length</span> <span class="op">&lt;</span> <span class="dv">215</span> <span class="op">&amp;&amp;</span></a>
<a class="sourceLine" id="cb1-19" title="19">            <span class="ss">/</span><span class="sc">^[\x20-\x7e]+$</span><span class="ss">/</span>.<span class="at">test</span>(input) <span class="op">&amp;&amp;</span></a>
<a class="sourceLine" id="cb1-20" title="20">            <span class="op">!</span><span class="ss">/</span><span class="sc">[.\[\]{}\s;`&#39;&quot;\\_&lt;&gt;?:]</span><span class="ss">/</span>.<span class="at">test</span>(input) <span class="op">&amp;&amp;</span></a>
<a class="sourceLine" id="cb1-21" title="21">            <span class="op">!</span><span class="va">input</span>.<span class="at">toLowerCase</span>().<span class="at">includes</span>(<span class="st">&quot;import&quot;</span>)</a>
<a class="sourceLine" id="cb1-22" title="22">        ) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-23" title="23">            <span class="cf">try</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-24" title="24">                <span class="kw">const</span> val <span class="op">=</span> <span class="va">vm</span>.<span class="at">runInNewContext</span>(input<span class="op">,</span> <span class="op">{}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-25" title="25">                <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Result:&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-26" title="26">                <span class="va">console</span>.<span class="at">log</span>(val)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-27" title="27">                <span class="va">console</span>.<span class="at">log</span>(</a>
<a class="sourceLine" id="cb1-28" title="28">                    <span class="st">&quot;See, isn&#39;t the calculator so much nicer when you&#39;re not trying to hack it?&quot;</span></a>
<a class="sourceLine" id="cb1-29" title="29">                )<span class="op">;</span></a>
<a class="sourceLine" id="cb1-30" title="30">            <span class="op">}</span> <span class="cf">catch</span> (e) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-31" title="31">                <span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;your tried&quot;</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-32" title="32">            <span class="op">}</span></a>
<a class="sourceLine" id="cb1-33" title="33">        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-34" title="34">            <span class="va">console</span>.<span class="at">log</span>(</a>
<a class="sourceLine" id="cb1-35" title="35">                <span class="st">&quot;Third time really is the charm! I&#39;ve finally created an unhackable system!&quot;</span></a>
<a class="sourceLine" id="cb1-36" title="36">            )<span class="op">;</span></a>
<a class="sourceLine" id="cb1-37" title="37">        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-38" title="38">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-39" title="39">)<span class="op">;</span></a></code></pre></div>
<p>There is a meager attempt at sandboxing with node’s <a href="https://nodejs.org/api/vm.html#vm-executing-javascript">vm</a>, but the documentation makes clear that that isn’t meant to be secure:</p>
<blockquote>
<p><strong>The vm module is not a security mechanism. Do not use it to run untrusted code.</strong></p>
</blockquote>
<p>We don’t need to be very creative and can just Google stuff like “vm.runInNewContext ctf” to find articles like <a href="https://pwnisher.gitlab.io/nodejs/sandbox/2019/02/21/sandboxing-nodejs-is-hard.html">Sandboxing NodeJS is hard, here’s why</a>, which explain that something like the following code can escape the <code>vm</code> easily.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">this</span>.<span class="va">constructor</span>.<span class="at">constructor</span>(<span class="st">&#39;return process&#39;</span>)()</a></code></pre></div>
<p>The main intrigue of this jail lies in the spicy regex check: <code>!/[.\[\]{}\s;`'"\\_&lt;&gt;?:]/.test(input)</code>. Before we think more about that, let’s look at what kind of code we want to run in the first place. I looked around and found it somewhat annoying to pop a shell with standard node libraries, but we can just read the file directly:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb3-1" title="1"><span class="at">require</span>(<span class="st">&quot;fs&quot;</span>).<span class="at">readFileSync</span>(<span class="st">&quot;flag.txt&quot;</span>)</a></code></pre></div>
<p>With our <code>vm.runInNewContext</code> jailbreak, it would look like:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">this</span>.<span class="va">constructor</span>.<span class="at">constructor</span>(<span class="st">&#39;return process.mainModule.require(&quot;fs&quot;).readFileSync(&quot;flag.txt&quot;)&#39;</span>)()</a></code></pre></div>
<p>Unfortunately, we are not allowed to use… a lot of characters. The main sources of annoyance are the banning of <code>.</code> and all the quotes, including <code>'</code> and <code>"</code> and the more modern <code>`</code>; secondarily, the lack of square brackets cuts off a Plan B for attribute access. Things we do have access to include all the alphanumerics, parentheses, commas, and the arithmetic operators.</p>
<p>For a bit, I tried looking at other JavaScript jail writeups for inspiration, and found the very impressive <a href="https://ctftime.org/writeup/15376">/[a-z().]/</a>, which only allows the characters in that regex. Still, the <code>.</code> in that challenge is very powerful because it granted access to attributes like <code>.length</code> and <code>.constructor</code>. In our challenge, we don’t even have, for example, <code>String.fromCharCode</code>.</p>
<p>Well, let’s look at what <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects">standard built-in objects</a> and <a href="https://nodejs.org/api/globals.html">Node global objects</a> we have access to:</p>
<ul>
<li><code>eval</code> is obviously good.</li>
<li><code>decodeURI</code> seems quite promising; the <code>%</code> used for URI escapes is not banned by the regex.</li>
<li>But the most interesting built-in I was reminded of by these lists was <code>RegExp</code>, even though directly calling it is not as useful.</li>
</ul>
<p>Of course! JavaScript supports regexp literals, which are delimited by <code>/</code>, which is not banned. The only remaining annoyance is that, when you convert a regexp to a string, it still has the <code>/</code>s — so if you <code>eval</code> a regexp, it’s still going to have the <code>/</code>s and will typically just evaluate to itself.</p>
<p>Fortunately, because this is JavaScript, you can add an integer to a regexp, and it converts both to a string:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode j"><code class="sourceCode j"><a class="sourceLine" id="cb5-1" title="1"><span class="kw">&gt;</span> <span class="dv">1</span> <span class="kw">+</span> <span class="kw">/</span>hi<span class="kw">/</span></a>
<a class="sourceLine" id="cb5-2" title="2"><span class="st">&#39;1/hi/&#39;</span></a></code></pre></div>
<p>What’s more, if you have code that’s a legal expression and you include <code>1+</code> and <code>+1</code> on the sides, you’ll get another legal expression after it’s surrounded by <code>1/</code> and <code>/1</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" title="1"><span class="op">&gt;</span> <span class="dv">1</span> <span class="op">+</span> <span class="ss">/1</span><span class="sc">+(</span><span class="ss">code</span><span class="sc">)+</span><span class="ss">1/</span> <span class="op">+</span> <span class="dv">1</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="st">&#39;1/1+(code)+1/1&#39;</span></a></code></pre></div>
<h3 id="the-final-exploit">The final exploit</h3>
<p>Short and sweet:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js breakword"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" title="1"><span class="at">eval</span>(<span class="at">decodeURI</span>(<span class="dv">1</span><span class="op">+</span><span class="ss">/1</span><span class="sc">+</span><span class="ss">this%2econstructor%2econstructor</span><span class="sc">(</span><span class="ss">%27return</span><span class="sc">(</span><span class="ss">process%2emainModule%2erequire</span><span class="sc">(</span><span class="ss">%22fs%22</span><span class="sc">)</span><span class="ss">%2ereadFileSync</span><span class="sc">(</span><span class="ss">%22flag%2etxt%22</span><span class="sc">))</span><span class="ss">%27</span><span class="sc">)()+</span><span class="ss">1/</span><span class="op">+</span><span class="dv">1</span>))</a></code></pre></div>
<p>This prints the flag (and some <code>1</code>s that are easy to ignore):</p>
<pre><code>actf{omg_js_is_like_so_quirky_haha}</code></pre>
<h3 id="alternate-approaches">Alternate approaches</h3>
<p>Quite a few alternative approaches were discussed in the official Discord and in <a href="https://blog.huli.tw/2022/05/05/en/angstrom-ctf-2022-writeup-en/">Huli’s writeup</a>:</p>
<ul>
<li>There are many other ways to get rid of the regex <code>/</code>s, for example by adding URI-escaped characters that turn them into harmless comments.</li>
<li>It’s also possible to use a snappier payload, <code>require('repl').start()</code>, which pops a <a href="https://nodejs.org/api/repl.html">Node REPL</a> instead of a shell (after which you can pop other things from the REPL).</li>
<li>The most different approach that was discussed, which was the author’s intended solution, is using the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/with"><code>with</code> statement</a> heavily as a substitute for attribute access. Roughly, inside a <code>with(foo)</code> block, a bare name <code>bar</code> is equivalent to <code>foo.bar</code>; so <code>String.fromCharCode</code> is suddenly viable again. Though <code>with</code> is obscure, I actually saw it in <a href="//blog.vero.site/post/js-safe-2">JS Safe 2.0</a> from Google CTF 2018.</li>
</ul></article>
	<footer class="post-footer">
		
		<ul class="post-tags">
			
			<li><a href="/tag/ctf"><span class="tag">CTF</span></a></li>
			
		</ul>
		
	</footer>
	<script data-isso="//node.vero.site/isso/" data-isso-css="false" src="//node.vero.site/isso/js/embed.min.js"></script>
	<section id="isso-thread"></section>
	<p class="comments-meta">(note: the commenting setup here is experimental and I may not check my comments often; if you want to tell <em>me</em> something instead of the world, email me!)</p>
	
	
	
	<footer class="post-footer">
		<nav class="pagination">
			
			<a class="pagination-previous" href="//blog.vero.site/post/interpret">← Interpreting Some Toy Neural Networks</a>
			
			
			<a class="pagination-next" href="//blog.vero.site/post/kevin-higgs">Kevin Higgs →</a>
			
		</nav>
	</footer>
</section>
</div>
<footer class="site-footer">
	<p>© 2017-2023 betaveros, Bounded-Error Log</p>
	<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />Except where otherwise noted, content on this site is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
	<p>Powered by <a href="https://gohugo.io/">Hugo</a>, <a href="http://pandoc.org/">pandoc</a>,
	<a href="https://www.goatcounter.com/">GoatCounter</a>,
	<a href="https://posativ.org/isso/">Isso</a>,
	<a href="https://pages.github.com/">GitHub Pages</a>, and
	<a href="https://www.cloudflare.com/">CloudFlare</a>.
	</p>
	<p>Opinions are mine and not of any employer, past or present.</p>
</footer>

<script src="/katex/katex.min.js"></script>
<script src="/katex/contrib/auto-render.min.js"></script>
<script>renderMathInElement(document.body);</script>
<script src="/js/bundle.js"></script>
<script>window.goatcounter = { path: function(p) { return '/blog' + p; } }</script>
<script data-goatcounter="https://node.vero.site:8073/count" async src="https://node.vero.site:8073/count.js"></script>
<script src="/js/jquery-3.2.1.min.js"></script>


</body>
</html>
